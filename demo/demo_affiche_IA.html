<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>Assistant Affiche IA - D√©mo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Police -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --green: #0A7F5A;
      --green-light: #e9f5ef;
      --feather: 16px;
      --top-slope: 10deg;
      --bottom-slope: -10deg;
      --radius: 18px;
      --header-width: 70%;
      --header-depth: 120px;
      --header-angle: 88%;
      --logo-scale: 1;
      --footer-depth: 140px;
      --footer-notch: 8%;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Poppins", Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    /* PANNEAUX */
    .controls {
      width: 360px;
      background: #fff;
      padding: 15px 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .05);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .controls-right {
      width: 320px;
      position: sticky;
      top: 20px;
    }

    .controls h2 {
      margin-top: 0;
      color: var(--green);
      font-size: 1.05rem;
    }

    .controls label {
      font-weight: 600;
      font-size: .78rem;
    }

    .range-control {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-bottom: 8px;
    }

    .range-control label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .7rem;
      font-weight: 600;
    }

    .range-control span {
      font-weight: 500;
      font-size: .68rem;
      color: #395247;
    }

    .range-control input[type="range"] {
      width: 100%;
    }

    .controls input[type="text"],
    .controls input[type="file"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #e1e1e1;
      border-radius: 6px;
      font-size: .8rem;
      background: #fff;
    }

    .controls button {
      width: 100%;
      background: var(--green);
      color: #fff;
      border: none;
      padding: 9px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: .85rem;
    }

    .detourage-panel {
      border: 1px dashed rgba(10, 127, 90, .35);
      border-radius: 10px;
      padding: 10px;
      margin-top: 4px;
      background: #f6faf8;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: .75rem;
    }

    .detourage-panel legend {
      font-weight: 600;
      font-size: .78rem;
      color: var(--green);
    }

    .detourage-modes {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detourage-modes label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .74rem;
      font-weight: 500;
      color: #395247;
    }

    .detourage-modes input[type="radio"] {
      accent-color: var(--green);
    }

    .tolerance-control {
      display: none;
      flex-direction: column;
      gap: 4px;
    }

    .tolerance-control.is-visible {
      display: flex;
    }

    .tolerance-control label {
      display: flex;
      justify-content: space-between;
      font-size: .7rem;
      font-weight: 600;
      color: #395247;
    }

    .tolerance-control input[type="range"] {
      width: 100%;
    }

    .detourage-note {
      font-size: .68rem;
      color: #7a8a81;
      margin: 0;
    }

    .model-choice {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 6px;
      border-radius: 8px;
      background: rgba(255, 255, 255, .65);
      border: 1px dashed rgba(10, 127, 90, .18);
      margin-top: 4px;
    }

    .model-choice span {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
    }

    .model-choice label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .74rem;
      font-weight: 500;
      color: #395247;
    }

    .model-choice small {
      font-size: .68rem;
      color: #7a8a81;
    }

    .detourage-status {
      margin-top: 6px;
      font-size: .7rem;
      color: #395247;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 18px;
    }

    .detourage-status::before {
      content: "üü¢";
      font-size: .7rem;
    }

    .detourage-status.loading::before {
      content: "";
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid rgba(9, 90, 65, .2);
      border-top-color: rgba(9, 90, 65, .8);
      animation: spin 0.8s linear infinite;
    }

    .detourage-status.error::before {
      content: "‚ö†Ô∏è";
      animation: none;
    }

    .controls button.secondary {
      background: #fff;
      color: var(--green);
      border: 1px solid rgba(10, 127, 90, .2);
    }

    .control-block {
      background: #f8f8f8;
      border: 1px solid rgba(0, 0, 0, .03);
      border-radius: 8px;
      padding: 6px;
    }

    .control-title {
      font-size: .7rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #494f4d;
    }

    /* CROIX + ZOOM (robuste via grid-areas) */
    .move-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .move-grid {
      display: grid;
      grid-template-columns: repeat(3, 30px);
      grid-template-rows: repeat(3, 30px);
      gap: 3px;
      justify-content: center;
      align-items: center;
      grid-template-areas:
        ". up ."
        "left . right"
        ". down .";
    }

    .move-btn {
      background: #fff;
      border: 1px solid rgba(10, 127, 90, .2);
      border-radius: 6px;
      cursor: pointer;
      font-size: .65rem;
      height: 28px;
      width: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    /* positionnement par classes (plus d‚ÄôIDs requis) */
    .move-btn.up {
      grid-area: up;
    }

    .move-btn.left {
      grid-area: left;
    }

    .move-btn.right {
      grid-area: right;
    }

    .move-btn.down {
      grid-area: down;
    }

    .zoom-buttons {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: center;
    }

    /* PREVIEW */
    .preview-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-width: 620px;
    }

    .affiche {
      width: 600px;
      height: 800px;
      background: radial-gradient(circle at top, #ffffff 0%, var(--green-light) 40%, #d7ece1 100%);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0, 0, 0, .12);
    }

    /* Bandeau haut */
    /* Bandeau haut arrondi et plus clair */
    .header-left {
      position: absolute;
      top: 0;
      left: 0;
      background: #0c8b64;
      /* plus clair que #0a7f5a */
      color: white;
      padding: 14px 18px 18px 22px;
      max-width: 70%;
      border-bottom-right-radius: 38px 42px;
      /* courbure douce */
      clip-path: path("M0,0 H100% L85%,100 Q75%,110 0,100 Z");
      /* arrondi organique */
      z-index: 3;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
    }

    .header-left::after {
      content: "";
      position: absolute;
      inset: -18px;
      background:
        linear-gradient(110deg,
          rgba(10, 127, 90, .65) 6%,
          rgba(10, 127, 90, .4) 15%,
          rgba(10, 127, 90, 0) 20%);
      clip-path: polygon(0 0, 100% 0, var(--header-angle) 100%, 0 100%);
      filter: blur(18px);
      opacity: .75;
      z-index: -1;
      pointer-events: none;
    }

    .header-left .promo-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin: 0;
    }

    .header-left .promo-date {
      font-size: .7rem;
      margin: 4px 0 0;
      opacity: .92;
    }

    /* LOGO */
    .logo {
      position: absolute;
      top: 18px;
      right: 18px;
      width: calc(110px * var(--logo-scale));
      height: calc(60px * var(--logo-scale));
      background: transparent;
      border-radius: 14px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: none;
      z-index: 4;
    }

    .logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .logo .placeholder {
      font-size: .65rem;
      color: rgba(0, 0, 0, .4);
      text-align: center;
      background: rgba(255, 255, 255, .25);
      padding: 4px 6px;
      border-radius: 8px;
    }

    /* GOMMETTE */
    .gommette {
      position: absolute;
      top: 120px;
      right: 35px;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, #ff9a7a 0%, #ff7b5a 45%, #ff5c32 100%);
      border-radius: 50%;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: 700;
      font-size: 1.3rem;
      letter-spacing: .01em;
      box-shadow: 0 8px 18px rgba(255, 123, 90, .42);
      z-index: 4;
      isolation: isolate;
      transform-origin: center center;
    }

    .gommette::after {
      content: "";
      position: absolute;
      inset: -18px;
      background: radial-gradient(circle, rgba(255, 123, 90, .35) 0%, rgba(255, 123, 90, 0) 70%);
      filter: blur(12px);
      z-index: -1;
      pointer-events: none;
    }

    /* PRODUIT */
    .product-image {
      position: absolute;
      top: 235px;
      left: 50%;
      transform: translateX(-50%);
      width: 360px;
      height: 280px;
      background: transparent;
      border: none;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      z-index: 6;
      transform-origin: center center;
      isolation: isolate;
      transition: .25s ease;
    }

    .product-image::after {
      content: "";
      position: absolute;
      inset: -28px;
      background: radial-gradient(circle,
          rgba(255, 255, 255, .85) 0%,
          rgba(255, 255, 255, .28) 55%,
          rgba(255, 255, 255, 0) 80%);
      filter: blur(18px);
      opacity: 0;
      transform: scale(.9);
      transition: .25s ease;
      pointer-events: none;
      z-index: -1;
    }

    .product-image.has-image::after {
      opacity: .8;
      transform: scale(1);
    }

    .product-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      background: transparent;
      position: relative;
      z-index: 1;
      transition: .25s ease;
    }

    .product-image.has-image img {
      filter: drop-shadow(0 12px 24px rgba(10, 127, 90, .25));
    }

    .product-placeholder {
      color: rgba(10, 127, 90, .5);
      text-align: center;
      font-size: .85rem;
      opacity: .6;
      background: rgba(255, 255, 255, .25);
      padding: 8px 10px;
      border-radius: 999px;
    }

    /* bulles d√©coratives */
    .bubble {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, .35);
      backdrop-filter: blur(3px);
      pointer-events: none;
      animation: float 12s ease-in-out infinite;
      z-index: 0;
    }

    .bubble.main {
      width: 95px;
      height: 95px;
      top: 320px;
      right: 150px;
    }

    .bubble.second {
      width: 120px;
      height: 120px;
      top: 380px;
      left: 45px;
      background: rgba(255, 255, 255, .22);
      animation-delay: 4s;
    }

    .bubble.third {
      width: 75px;
      height: 75px;
      top: 520px;
      right: 60px;
      background: rgba(255, 255, 255, .15);
      animation-delay: 7s;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0) scale(1);
      }

      50% {
        transform: translateY(-10px) scale(1.03);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Bandeau bas */
    .footer-band {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      min-height: clamp(90px, var(--footer-depth), 320px);
      background:
        linear-gradient(120deg,
          #0A7F5A 0%,
          rgba(8, 140, 106, .92) 60%,
          rgba(8, 140, 106, 0) 100%),
        #0A7F5A;
      color: #fff;
      padding: clamp(14px, calc(var(--footer-depth) * 0.25), 38px) 24px clamp(20px, calc(var(--footer-depth) * 0.45), 58px);
      display: flex;
      flex-direction: column;
      gap: 6px;
      clip-path: polygon(0 var(--footer-notch), 100% 0, 100% 100%, 0 100%);
      transition: .2s ease;
      backdrop-filter: blur(1px);
      isolation: isolate;
      z-index: 2;
    }

    .footer-band::before {
      content: "";
      position: absolute;
      inset: -24px;
      background:
        linear-gradient(120deg,
          rgba(8, 140, 106, .7) 0%,
          rgba(8, 140, 106, .45) 55%,
          rgba(8, 140, 106, 0) 100%);
      clip-path: polygon(0 var(--footer-notch), 100% 0, 100% 100%, 0 100%);
      filter: blur(26px);
      opacity: .8;
      pointer-events: none;
      z-index: -1;
    }

    .footer-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .footer-subtitle {
      font-size: .78rem;
      opacity: .85;
    }

    /* Slogans */
    #sloganResults .slogan-option {
      background: #fff;
      border: 1px solid rgba(10, 127, 90, .15);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: .72rem;
      line-height: 1.3;
      cursor: pointer;
      transition: .15s ease;
      word-break: break-word;
    }

    #sloganResults .slogan-option:hover {
      background: rgba(10, 127, 90, .06);
    }
  </style>
</head>

<body>

  <!-- COLONNE GAUCHE : Infos (sans fl√®ches) -->
  <div class="controls">
    <h2>Param√®tres de l'affiche</h2>

    <label>Titre de la promo</label>
    <input id="promoTitle" type="text" placeholder="Promo d'automne - Vitamine D" />

    <label>Date / p√©riode</label>
    <input id="promoDate" type="text" placeholder="Du 1er au 15 novembre" />

    <label>Texte promo (gommette)</label>
    <input id="promoBadge" type="text" placeholder="-20% / 2=3 / Offre Fid√©lit√©" />

    <label>Nom du produit</label>
    <input id="productName" type="text" placeholder="Vitamine D3 Senior 1000 UI" />

    <label>Texte compl√©mentaire</label>
    <input id="productSubtitle" type="text" placeholder="Demandez conseil √† votre pharmacien" />

    <label>Slogan g√©n√©r√©</label>
    <input id="sloganField" type="text" placeholder="Votre slogan ici" />

    <label>Logo pharmacie</label>
    <input id="logoInput" type="file" accept="image/*" />
    <div class="range-control">
      <label for="logoScaleRange">Taille logo <span id="logoScaleValue">100%</span></label>
      <input id="logoScaleRange" type="range" min="50" max="150" value="100" />
    </div>

    <label>Photo produit</label>
    <input id="productInput" type="file" accept="image/*" />

    <fieldset class="detourage-panel">
      <legend>ü™Ñ D√©tourage</legend>
      <div class="detourage-modes">
        <label><input type="radio" name="detourageMode" value="auto" checked />Auto (recommand√©)</label>
        <label><input type="radio" name="detourageMode" value="ia" />Forcer IA (U¬≤-Net)</label>
        <label><input type="radio" name="detourageMode" value="color" />Forcer d√©tourage Couleur</label>
      </div>
      <div class="tolerance-control" id="toleranceControl">
        <label for="toleranceRange">Tol√©rance <span id="toleranceValue">40</span></label>
        <input type="range" id="toleranceRange" min="0" max="60" value="40" />
      </div>
      <div class="model-choice">
        <span>Mod√®le IA</span>
        <label>
          <input type="radio" name="u2netModel" value="u2netp.onnx" checked />
          <span>u2netp.onnx <small>(fond uni)</small></span>
        </label>
        <label>
          <input type="radio" name="u2netModel" value="u2net.onnx" />
          <span>u2net.onnx <small>(images encombr√©es)</small></span>
        </label>
      </div>
      <p class="detourage-note">Les images restent sur votre appareil.</p>
    </fieldset>

    <div class="detourage-status" id="detourageStatus">Initialisation de l'IA‚Ä¶</div>

    <button id="updateBtn">Mettre √† jour l'affiche</button>
    <button id="sloganBtn" class="secondary">üí° Proposer des slogans</button>
  </div>

  <!-- PREVIEW CENTRE -->
  <div class="preview-container">
    <div class="affiche" id="affiche">
      <div class="header-left">
        <p class="promo-title" id="afficheTitle">Promo d'automne - Vitamine D</p>
        <p class="promo-date" id="afficheDate">Du 1er au 15 novembre</p>
      </div>

      <div class="logo" id="afficheLogo"><span class="placeholder">logo</span></div>
      <div class="gommette" id="afficheBadge">-20%</div>
      <div class="product-image" id="afficheProduct">
        <div class="product-placeholder">Photo du produit<br />ici</div>
      </div>

      <div class="bubble main"></div>
      <div class="bubble second"></div>
      <div class="bubble third"></div>

      <div class="footer-band">
        <div class="footer-title" id="afficheProductName">Vitamine D3 Senior 1000 UI</div>
        <div class="footer-subtitle" id="afficheProductSubtitle">Demandez conseil √† votre pharmacien</div>
      </div>
    </div>
  </div>

  <!-- PANNEAU DROIT : Cr√©ation & Contr√¥les (croix OK) -->
  <div class="controls controls-right">
    <h2>Cr√©ation & Contr√¥les</h2>

    <button class="secondary beautyBtn">‚ú® Am√©liorer le visuel</button>

    <div class="control-block">
      <div class="control-title">Position gommette</div>
      <div class="move-controls">
        <div class="move-grid">
          <button class="move-btn up" data-ctrl="g" data-cmd="up">‚Üë</button>
          <button class="move-btn left" data-ctrl="g" data-cmd="left">‚Üê</button>
          <button class="move-btn right" data-ctrl="g" data-cmd="right">‚Üí</button>
          <button class="move-btn down" data-ctrl="g" data-cmd="down">‚Üì</button>
        </div>
        <div class="zoom-buttons">
          <button class="move-btn" data-ctrl="g" data-cmd="plus">+</button>
          <button class="move-btn" data-ctrl="g" data-cmd="minus">‚àí</button>
        </div>
      </div>
    </div>

    <div class="control-block">
      <div class="control-title">Position produit</div>
      <div class="move-controls">
        <div class="move-grid">
          <button class="move-btn up" data-ctrl="p" data-cmd="up">‚Üë</button>
          <button class="move-btn left" data-ctrl="p" data-cmd="left">‚Üê</button>
          <button class="move-btn right" data-ctrl="p" data-cmd="right">‚Üí</button>
          <button class="move-btn down" data-ctrl="p" data-cmd="down">‚Üì</button>
        </div>
        <div class="zoom-buttons">
          <button class="move-btn" data-ctrl="p" data-cmd="plus">+</button>
          <button class="move-btn" data-ctrl="p" data-cmd="minus">‚àí</button>
        </div>
      </div>
    </div>

    <div class="control-block">
      <div class="control-title">Bandeaux & fades</div>

      <div class="range-control">
        <label for="headerWidthRange">Largeur bandeau haut <span id="headerWidthValue">70%</span></label>
        <input type="range" id="headerWidthRange" min="45" max="95" value="70" />
      </div>

      <div class="range-control">
        <label for="headerDepthRange">Hauteur bandeau haut <span id="headerDepthValue">120px</span></label>
        <input type="range" id="headerDepthRange" min="80" max="220" value="120" />
      </div>

      <div class="range-control">
        <label for="headerAngleRange">Angle coupe haut <span id="headerAngleValue">88%</span></label>
        <input type="range" id="headerAngleRange" min="55" max="100" value="88" />
      </div>

      <div class="range-control">
        <label for="footerDepthRange">Hauteur bandeau bas <span id="footerDepthValue">140px</span></label>
        <input type="range" id="footerDepthRange" min="100" max="260" value="140" />
      </div>

      <div class="range-control">
        <label for="footerAngleRange">Angle coupe bas <span id="footerAngleValue">8%</span></label>
        <input type="range" id="footerAngleRange" min="0" max="20" value="8" />
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script type="module">
    // --- Constantes & chemins dynamiques ---
    const DETOUR_MODE = Object.freeze({ AUTO: 'auto', IA: 'ia', COLOR: 'color' });
    const DEFAULT_MODEL_CHOICE = 'u2netp.onnx';
    const resolveAssetUrl = (relativePath) => new URL(relativePath, import.meta.url).href;
    const MODULE_PATH = resolveAssetUrl('../assets/js/bgremoval.mjs');
    let modelChoice = DEFAULT_MODEL_CHOICE;
    const getModelUrl = () => resolveAssetUrl(`../models/${modelChoice}`);

    // --- R√©f√©rences DOM ---
    const titleInput = document.getElementById('promoTitle');
    const dateInput = document.getElementById('promoDate');
    const badgeInput = document.getElementById('promoBadge');
    const productNameInput = document.getElementById('productName');
    const productSubtitleInput = document.getElementById('productSubtitle');
    const sloganField = document.getElementById('sloganField');
    const logoInput = document.getElementById('logoInput');
    const productInput = document.getElementById('productInput');
    const logoScaleRange = document.getElementById('logoScaleRange');
    const logoScaleValue = document.getElementById('logoScaleValue');
    const detourageStatusEl = document.getElementById('detourageStatus');
    const toleranceRange = document.getElementById('toleranceRange');
    const toleranceValue = document.getElementById('toleranceValue');
    const toleranceContainer = document.getElementById('toleranceControl');
    const detourageModeInputs = document.querySelectorAll('input[name="detourageMode"]');
    const modelChoiceInputs = document.querySelectorAll('input[name="u2netModel"]');

    const updateBtn = document.getElementById('updateBtn');
    const sloganBtn = document.getElementById('sloganBtn');

    const affiche = document.getElementById('affiche');
    const afficheTitle = document.getElementById('afficheTitle');
    const afficheDate = document.getElementById('afficheDate');
    const afficheBadge = document.getElementById('afficheBadge');
    const afficheProductName = document.getElementById('afficheProductName');
    const afficheProductSubtitle = document.getElementById('afficheProductSubtitle');
    const afficheLogo = document.getElementById('afficheLogo');
    const afficheProduct = document.getElementById('afficheProduct');
    const sloganResults = document.getElementById('sloganResults');

    const root = document.documentElement;

    const sampleCanvas = document.createElement('canvas');
    const sampleCtx = sampleCanvas.getContext('2d');

    const state = {
      lastLogoImage: null,
      lastProductImage: null,
      lastLogoFile: null,
      lastProductFile: null,
      lastLogoDataURL: null,
      lastProductDataURL: null,
      lastLogoMode: null,
      lastProductMode: null,
      logoManualColor: null,
    };

    const selectedModelInput = document.querySelector('input[name="u2netModel"]:checked');
    if (selectedModelInput?.value) {
      modelChoice = selectedModelInput.value;
    }

    // --- UI helpers ---
    const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
    const clamp255 = (value) => clamp(value, 0, 255);

    const getToleranceValue = () => Number(toleranceRange?.value || 40);

    const setToleranceVisibility = (visible) => {
      if (!toleranceContainer) return;
      toleranceContainer.classList.toggle('is-visible', Boolean(visible));
    };
    setToleranceVisibility(false);

    const updateToleranceLabel = () => {
      if (toleranceValue) toleranceValue.textContent = getToleranceValue();
    };
    updateToleranceLabel();
    if (toleranceRange) {
      toleranceRange.addEventListener('input', async () => {
        updateToleranceLabel();
        await rerunColorIfNeeded();
      });
    }

    const setDetourageStatus = (text, state = 'idle') => {
      if (!detourageStatusEl) return;
      detourageStatusEl.textContent = text;
      detourageStatusEl.classList.toggle('loading', state === 'loading');
      detourageStatusEl.classList.toggle('error', state === 'error');
      detourageStatusEl.classList.toggle('idle', state === 'idle');
    };
    setDetourageStatus("Initialisation du mod√®le IA‚Ä¶", 'loading');

    let u2netInitPromise;
    let providerLogged = false;

    const getSelectedDetourMode = () => {
      const checked = document.querySelector('input[name="detourageMode"]:checked');
      return (checked?.value || DETOUR_MODE.AUTO);
    };

    detourageModeInputs.forEach((input) => {
      input.addEventListener('change', () => {
        if (!input.checked) return;
        const wantsColor = input.value === DETOUR_MODE.COLOR;
        setToleranceVisibility(wantsColor);
      });
    });

    modelChoiceInputs.forEach((input) => {
      input.addEventListener('change', () => {
        if (!input.checked) return;
        if (!input.value || input.value === modelChoice) return;
        modelChoice = input.value;
        providerLogged = false;
        u2netInitPromise = null;
        setDetourageStatus('Initialisation du mod√®le IA‚Ä¶', 'loading');
        ensureU2NetReady().catch(() => {
          // status already handled in ensureU2NetReady
        });
      });
    });

    // --- Module IA ---
    let initU2Net;
    let removeBgFromFile;
    try {
      ({ initU2Net, removeBgFromFile } = await import(MODULE_PATH));
    } catch (err) {
      console.error('Impossible de charger le module de d√©tourage :', err);
      setDetourageStatus('Module IA introuvable, utilisez "Couleur".', 'error');
    }

    const ensureU2NetReady = async () => {
      if (!initU2Net) {
        throw new Error('Module IA non disponible.');
      }
      if (!u2netInitPromise) {
        setDetourageStatus('Initialisation du mod√®le IA‚Ä¶', 'loading');
        u2netInitPromise = initU2Net({
          modelUrl: getModelUrl(),
          providers: ['webgpu', 'webgl', 'wasm'],
        })
          .then((session) => {
            console.log('[D√©tourage] Session U¬≤-Net initialis√©e.');
            setDetourageStatus('IA pr√™te üü¢');
            return session;
          })
          .catch((err) => {
            console.error('initU2Net error', err);
            setDetourageStatus('IA indisponible, essayez "Couleur".', 'error');
            throw err;
          });
      }
      return u2netInitPromise;
    };

    ensureU2NetReady().catch(() => {
      // Le flux Couleur reste disponible.
    });

    // --- Utilitaires g√©n√©raux ---
    const readFileAsDataURL = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = () => reject(new Error('Lecture fichier impossible.'));
      reader.readAsDataURL(file);
    });

    const fileToImage = async (file) => {
      const dataURL = await readFileAsDataURL(file);
      const image = await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = dataURL;
      });
      return { image, dataURL };
    };

    const loadImageFromDataURL = (dataURL) => new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = dataURL;
    });

    const injectImage = (container, dataURL) => {
      if (!container) return;
      container.innerHTML = '';
      const img = document.createElement('img');
      img.src = dataURL;
      container.appendChild(img);
      container.classList.add('has-image');
    };

    const isLikelyLogo = (file, img) => {
      if (!file || !img) return false;
      const name = (file.name || '').toLowerCase();
      if (/logo|mark/.test(name)) return true;
      return img.width < 256 || img.height < 256;
    };

    const applyUnsharpMask = (imageData) => {
      const { width, height, data } = imageData;
      const srcCopy = new Uint8ClampedArray(data);
      sampleCanvas.width = width;
      sampleCanvas.height = height;
      sampleCtx.putImageData(imageData, 0, 0);

      const blurCanvas = document.createElement('canvas');
      blurCanvas.width = width;
      blurCanvas.height = height;
      const blurCtx = blurCanvas.getContext('2d');
      if ('filter' in blurCtx) {
        blurCtx.filter = 'blur(1px)';
      }
      blurCtx.drawImage(sampleCanvas, 0, 0);
      const blurData = blurCtx.getImageData(0, 0, width, height).data;

      for (let i = 0; i < data.length; i += 4) {
        data[i] = clamp255(srcCopy[i] + 0.5 * (srcCopy[i] - blurData[i]));
        data[i + 1] = clamp255(srcCopy[i + 1] + 0.5 * (srcCopy[i + 1] - blurData[i + 1]));
        data[i + 2] = clamp255(srcCopy[i + 2] + 0.5 * (srcCopy[i + 2] - blurData[i + 2]));
      }
      return imageData;
    };

    const pickPixel = (imageData, x, y) => {
      const { width, data } = imageData;
      const idx = (y * width + x) * 4;
      return {
        r: data[idx],
        g: data[idx + 1],
        b: data[idx + 2],
      };
    };

    const applyColorKey = (imageData, keyColor, tolerance) => {
      const data = imageData.data;
      const threshold = Number.isFinite(tolerance) ? tolerance : 40;
      for (let i = 0; i < data.length; i += 4) {
        const dr = Math.abs(data[i] - keyColor.r);
        const dg = Math.abs(data[i + 1] - keyColor.g);
        const db = Math.abs(data[i + 2] - keyColor.b);
        const diff = dr + dg + db;
        data[i + 3] = diff <= threshold ? 0 : 255;
      }
    };

    const extractAlpha = (imageData) => {
      const len = imageData.width * imageData.height;
      const data = imageData.data;
      const alpha = new Float32Array(len);
      for (let i = 0; i < len; i += 1) {
        alpha[i] = data[i * 4 + 3] / 255;
      }
      return alpha;
    };

    const writeAlpha = (imageData, alpha) => {
      const len = imageData.width * imageData.height;
      const data = imageData.data;
      for (let i = 0; i < len; i += 1) {
        data[i * 4 + 3] = clamp255(Math.round(alpha[i] * 255));
      }
    };

    const dilateAlpha = (alpha, width, height) => {
      const out = new Float32Array(alpha.length);
      for (let y = 0; y < height; y += 1) {
        for (let x = 0; x < width; x += 1) {
          let max = 0;
          for (let dy = -1; dy <= 1; dy += 1) {
            for (let dx = -1; dx <= 1; dx += 1) {
              const nx = clamp(x + dx, 0, width - 1);
              const ny = clamp(y + dy, 0, height - 1);
              max = Math.max(max, alpha[ny * width + nx]);
            }
          }
          out[y * width + x] = max;
        }
      }
      return out;
    };

    const erodeAlpha = (alpha, width, height) => {
      const out = new Float32Array(alpha.length);
      for (let y = 0; y < height; y += 1) {
        for (let x = 0; x < width; x += 1) {
          let min = 1;
          for (let dy = -1; dy <= 1; dy += 1) {
            for (let dx = -1; dx <= 1; dx += 1) {
              const nx = clamp(x + dx, 0, width - 1);
              const ny = clamp(y + dy, 0, height - 1);
              min = Math.min(min, alpha[ny * width + nx]);
            }
          }
          out[y * width + x] = min;
        }
      }
      return out;
    };

    const blurAlpha = (alpha, width, height) => {
      const out = new Float32Array(alpha.length);
      for (let y = 0; y < height; y += 1) {
        for (let x = 0; x < width; x += 1) {
          let acc = 0;
          let count = 0;
          for (let dy = -1; dy <= 1; dy += 1) {
            for (let dx = -1; dx <= 1; dx += 1) {
              const nx = clamp(x + dx, 0, width - 1);
              const ny = clamp(y + dy, 0, height - 1);
              acc += alpha[ny * width + nx];
              count += 1;
            }
          }
          out[y * width + x] = acc / count;
        }
      }
      return out;
    };

    const softenAlpha = (imageData) => {
      const width = imageData.width;
      const height = imageData.height;
      let alpha = extractAlpha(imageData);
      alpha = dilateAlpha(alpha, width, height);
      alpha = erodeAlpha(alpha, width, height);
      alpha = blurAlpha(alpha, width, height);
      writeAlpha(imageData, alpha);
    };

    const runColorKeyDetour = async (image, { tolerance, keyColor }) => {
      const canvas = document.createElement('canvas');
      canvas.width = image.width;
      canvas.height = image.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(image, 0, 0);
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      imageData = applyUnsharpMask(imageData);
      ctx.putImageData(imageData, 0, 0);
      const working = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const sampledColor = keyColor || pickPixel(working, 0, 0);
      applyColorKey(working, sampledColor, tolerance);
      softenAlpha(working);
      ctx.putImageData(working, 0, 0);
      return { dataURL: canvas.toDataURL('image/png'), sampledColor };
    };

    const sampleColorFromOriginal = (image, ratioX, ratioY) => {
      if (!image) return null;
      sampleCanvas.width = image.width;
      sampleCanvas.height = image.height;
      sampleCtx.drawImage(image, 0, 0);
      const x = clamp(Math.round(clamp(ratioX, 0, 1) * (image.width - 1)), 0, image.width - 1);
      const y = clamp(Math.round(clamp(ratioY, 0, 1) * (image.height - 1)), 0, image.height - 1);
      const pixel = sampleCtx.getImageData(x, y, 1, 1).data;
      return { r: pixel[0], g: pixel[1], b: pixel[2] };
    };

    const isMaskFlat = async (alphaDataURL) => {
      if (!alphaDataURL) return false;
      try {
        const img = await loadImageFromDataURL(alphaDataURL);
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const { data } = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let mid = 0;
        let total = 0;
        for (let i = 0; i < data.length; i += 4) {
          const alpha = data[i];
          if (alpha > 15 && alpha < 240) mid += 1;
          total += 1;
        }
        if (!total) return true;
        return (mid / total) < 0.01;
      } catch {
        return false;
      }
    };

    const smartDetour = async (file, image, requestedMode, { isLogo = false, manualKeyColor = null, tolerance = getToleranceValue() } = {}) => {
      let effectiveMode = requestedMode;
      if (effectiveMode === DETOUR_MODE.AUTO) {
        if (isLogo) {
          effectiveMode = DETOUR_MODE.COLOR;
        } else if (isLikelyLogo(file, image)) {
          effectiveMode = DETOUR_MODE.COLOR;
        } else {
          effectiveMode = DETOUR_MODE.IA;
        }
      }

      if (effectiveMode === DETOUR_MODE.IA) {
        await ensureU2NetReady();
        if (!removeBgFromFile) {
          throw new Error('removeBgFromFile indisponible.');
        }
        const result = await removeBgFromFile(file, { feather: 1.5, threshold: 0.7 });
        if (!providerLogged && result?.provider) {
          console.log(`[D√©tourage] Provider IA utilis√© : ${result.provider}`);
          providerLogged = true;
        }
        if (await isMaskFlat(result?.alphaMask)) {
          throw new Error('flat_mask');
        }
        return { dataURL: result.rgbaDataURL, modeUsed: DETOUR_MODE.IA, provider: result?.provider || 'inconnu' };
      }

      const { dataURL, sampledColor } = await runColorKeyDetour(image, {
        tolerance,
        keyColor: manualKeyColor,
      });
      return {
        dataURL,
        modeUsed: DETOUR_MODE.COLOR,
        sampledColor,
      };
    };

    async function rerunColorIfNeeded() {
      if (state.lastLogoMode === DETOUR_MODE.COLOR && state.lastLogoImage) {
        await rerunLogoColor();
      } else if (state.lastProductMode === DETOUR_MODE.COLOR && state.lastProductImage) {
        await rerunProductColor();
      }
    }

    async function rerunLogoColor() {
      if (!state.lastLogoImage || !state.lastLogoFile) return;
      setDetourageStatus('Ajustement du logo‚Ä¶', 'loading');
      try {
        const result = await smartDetour(state.lastLogoFile, state.lastLogoImage, DETOUR_MODE.COLOR, {
          isLogo: true,
          manualKeyColor: state.logoManualColor,
          tolerance: getToleranceValue(),
        });
        injectImage(afficheLogo, result.dataURL);
        state.lastLogoMode = result.modeUsed;
        setDetourageStatus('Logo √† jour ‚úÖ');
      } catch (err) {
        console.error('Erreur d√©tourage logo', err);
        setDetourageStatus('Logo non mis √† jour.', 'error');
      }
    }

    async function rerunProductColor() {
      if (!state.lastProductImage || !state.lastProductFile) return;
      setDetourageStatus('Ajustement du produit‚Ä¶', 'loading');
      try {
        const result = await smartDetour(state.lastProductFile, state.lastProductImage, DETOUR_MODE.COLOR, {
          tolerance: getToleranceValue(),
        });
        injectImage(afficheProduct, result.dataURL);
        state.lastProductMode = result.modeUsed;
        setDetourageStatus('Produit mis √† jour ‚úÖ');
      } catch (err) {
        console.error('Erreur d√©tourage produit', err);
        setDetourageStatus('Produit non mis √† jour.', 'error');
      }
    }

    // --- Gestionnaires upload ---
    const handleLogoChange = async () => {
      const file = logoInput?.files?.[0];
      if (!file) return;
      setDetourageStatus('D√©tection du logo‚Ä¶', 'loading');
      let lastDataURL;
      try {
        const { image, dataURL } = await fileToImage(file);
        state.lastLogoImage = image;
        state.lastLogoFile = file;
        state.lastLogoDataURL = dataURL;
        lastDataURL = dataURL;
        state.logoManualColor = null;

        const result = await smartDetour(file, image, getSelectedDetourMode(), { isLogo: true });
        injectImage(afficheLogo, result.dataURL);
        state.lastLogoMode = result.modeUsed;
        setToleranceVisibility(result.modeUsed === DETOUR_MODE.COLOR);
        setDetourageStatus(result.modeUsed === DETOUR_MODE.IA ? 'Logo d√©tour√© par IA ‚úÖ' : 'Logo d√©tour√© ‚úÖ');
      } catch (err) {
        console.error('Logo detour error', err);
        const isFlatMask = err?.message === 'flat_mask';
        const message = isFlatMask ? 'IA confuse sur ce logo, testez "Couleur".' : '√âchec d√©tourage logo.';
        setDetourageStatus(`${message} (affich√© avec fond)`, 'error');
        if (lastDataURL) {
          injectImage(afficheLogo, lastDataURL);
          state.lastLogoMode = null;
          setToleranceVisibility(getSelectedDetourMode() === DETOUR_MODE.COLOR);
        }
      }
    };

    const handleProductChange = async () => {
      const file = productInput?.files?.[0];
      if (!file) return;
      setDetourageStatus('D√©tourage du produit‚Ä¶', 'loading');
      let lastDataURL;
      try {
        const { image, dataURL } = await fileToImage(file);
        state.lastProductImage = image;
        state.lastProductFile = file;
        state.lastProductDataURL = dataURL;
        lastDataURL = dataURL;

        const result = await smartDetour(file, image, getSelectedDetourMode());
        injectImage(afficheProduct, result.dataURL);
        state.lastProductMode = result.modeUsed;
        setToleranceVisibility(result.modeUsed === DETOUR_MODE.COLOR);
        if (result.modeUsed === DETOUR_MODE.IA) {
          setDetourageStatus(`Produit d√©tour√© par IA (${result.provider || 'IA'}) ‚úÖ`);
        } else {
          setDetourageStatus('Produit d√©tour√© (Couleur) ‚úÖ');
        }
      } catch (err) {
        console.error('Product detour error', err);
        const isFlatMask = err?.message === 'flat_mask';
        const msg = isFlatMask
          ? 'IA h√©sitante : essayez "Forcer Couleur".'
          : '√âchec IA, essayez "Forcer Couleur".';
        setDetourageStatus(`${msg} (affich√© avec fond)`, 'error');
        if (lastDataURL) {
          injectImage(afficheProduct, lastDataURL);
          state.lastProductMode = null;
          setToleranceVisibility(getSelectedDetourMode() === DETOUR_MODE.COLOR);
        }
      }
    };

    logoInput?.addEventListener('change', handleLogoChange);
    productInput?.addEventListener('change', handleProductChange);

    // Eyedropper sur le logo
    afficheLogo?.addEventListener('click', async (event) => {
      if (state.lastLogoMode !== DETOUR_MODE.COLOR || !state.lastLogoImage) return;
      const img = afficheLogo.querySelector('img');
      if (!img) return;
      const rect = img.getBoundingClientRect();
      const ratioX = (event.clientX - rect.left) / rect.width;
      const ratioY = (event.clientY - rect.top) / rect.height;
      const sampled = sampleColorFromOriginal(state.lastLogoImage, ratioX, ratioY);
      if (!sampled) return;
      state.logoManualColor = sampled;
      await rerunLogoColor();
    });

    // --- Synchronisation contenu affiche ---
    const syncText = (input, target, fallback = "") => {
      if (!target) return;
      target.textContent = input.value || fallback;
    };

    updateBtn?.addEventListener('click', () => {
      afficheTitle.textContent = titleInput.value || "Promotion en pharmacie";
      afficheDate.textContent = dateInput.value || "P√©riode de l'offre";
      afficheBadge.textContent = badgeInput.value || "-20%";
      afficheProductName.textContent = productNameInput.value || "Nom du produit";
      afficheProductSubtitle.textContent = productSubtitleInput.value || "Texte compl√©mentaire";
      afficheLogo.classList.add('has-image');
      afficheProduct.classList.add('has-image');
    });

    titleInput?.addEventListener('input', () => syncText(titleInput, afficheTitle, "Promo sp√©ciale en pharmacie"));
    dateInput?.addEventListener('input', () => syncText(dateInput, afficheDate, "P√©riode de l'offre"));
    badgeInput?.addEventListener('input', () => syncText(badgeInput, afficheBadge, "-20%"));
    productNameInput?.addEventListener('input', () => syncText(productNameInput, afficheProductName, "Nom du produit"));
    productSubtitleInput?.addEventListener('input', () => syncText(productSubtitleInput, afficheProductSubtitle, "Un sous-titre percutant ici"));
    sloganField?.addEventListener('input', () => syncText(sloganField, afficheProductSubtitle, "Un slogan sur mesure"));

    // --- G√©n√©ration slogans ---
    const OPENERS = [
      "Parce que votre sant√© compte ‚ú®", "Le conseil de votre pharmacie :", "Pour prolonger l'√©t√© ‚òÄÔ∏è",
      "L'essentiel de la saison üçÅ", "La cure qu'il vous faut üíä"
    ];
    const HOOKS = [
      "Renforce l'immunit√© naturellement", "Formule experte, r√©sultats rapides",
      "Approuv√© par l'√©quipe officinale", "Pour toute la famille", "Qualit√© officine"
    ];
    const BENEFITS = [
      "Vitalit√© retrouv√©e", "Immunit√© renforc√©e", "√âquilibre parfait",
      "√ânergie naturelle", "Protection au quotidien"
    ];
    const CTA = [
      "Disponible en pharmacie", "Demandez conseil √† votre pharmacien",
      "Profitez de l'offre d√®s aujourd'hui", "Offre limit√©e en stock", "√Ä d√©couvrir maintenant"
    ];
    const ENDINGS = [
      "R√©serv√© √† votre pharmacie pr√©f√©r√©e", "√Ä prix doux en ce moment", "√Ä retrouver en comptoir",
      "Votre geste bien-√™tre du jour", "Une offre exclusive officine"
    ];
    const CALLINGS = [
      "Passez en officine ‚ûú", "On vous attend au comptoir üíä", "Conseil personnalis√© en pharmacie",
      "Profitez-en tant que c'est dispo ‚úÖ", "Offre d√©mo ‚Äì testez-la sur vos produits"
    ];
    const rand = (n) => Math.floor(Math.random() * n);

    sloganBtn?.addEventListener('click', () => {
      sloganResults.innerHTML = '';
      const name = (productNameInput.value || "notre produit").trim();
      const promo = badgeInput.value ? ` (${badgeInput.value})` : "";
      const s1 = `${OPENERS[rand(OPENERS.length)]} ${name}${promo}`;
      const s2 = `${name} : ${CTA[rand(CTA.length)]}`;
      const s3 = `${HOOKS[rand(HOOKS.length)]} ‚Äì ${ENDINGS[rand(ENDINGS.length)]}`;
      const s4 = `${name}${promo} : ${CALLINGS[rand(CALLINGS.length)]}`;
      [s1, s2, s3, s4].forEach((text) => {
        const div = document.createElement('div');
        div.className = "slogan-option";
        div.textContent = text;
        div.addEventListener('click', () => {
          sloganField.value = text;
          afficheProductSubtitle.textContent = text;
        });
        sloganResults.appendChild(div);
      });
    });

    document.querySelectorAll('.beautyBtn').forEach((btn) => {
      btn.addEventListener('click', () => {
        affiche.style.filter = "drop-shadow(0 10px 25px rgba(0,0,0,0.25))";
      });
    });

    // --- Contr√¥les d√©placement / zoom ---
    const gEl = document.getElementById('afficheBadge');
    const pEl = document.getElementById('afficheProduct');
    let gTop = 120;
    let gLeft = 600 - 35 - 150;
    let gScale = 1;
    let pTop = 235;
    let pScale = 1;
    let pOffsetX = 0;

    const applyProductTransform = () => {
      if (!pEl) return;
      pEl.style.transform = `translateX(-50%) translateX(${pOffsetX}px) scale(${pScale})`;
    };
    applyProductTransform();

    const handleMove = (ctrl, cmd) => {
      if (ctrl === 'g') {
        if (cmd === 'up') { gTop -= 10; gEl.style.top = `${gTop}px`; }
        if (cmd === 'down') { gTop += 10; gEl.style.top = `${gTop}px`; }
        if (cmd === 'left') { gLeft -= 10; gEl.style.right = "auto"; gEl.style.left = `${gLeft}px`; }
        if (cmd === 'right') { gLeft += 10; gEl.style.right = "auto"; gEl.style.left = `${gLeft}px`; }
        if (cmd === 'plus') { gScale += 0.05; gEl.style.transform = `scale(${gScale})`; }
        if (cmd === 'minus') { gScale = Math.max(0.5, gScale - 0.05); gEl.style.transform = `scale(${gScale})`; }
      }
      if (ctrl === 'p') {
        if (cmd === 'up') { pTop -= 10; pEl.style.top = `${pTop}px`; }
        if (cmd === 'down') { pTop += 10; pEl.style.top = `${pTop}px`; }
        if (cmd === 'left') { pOffsetX -= 10; applyProductTransform(); }
        if (cmd === 'right') { pOffsetX += 10; applyProductTransform(); }
        if (cmd === 'plus') { pScale += 0.05; applyProductTransform(); }
        if (cmd === 'minus') { pScale = Math.max(0.5, pScale - 0.05); applyProductTransform(); }
      }
    };

    document.addEventListener('click', (event) => {
      const btn = event.target.closest('[data-ctrl][data-cmd]');
      if (!btn) return;
      handleMove(btn.dataset.ctrl, btn.dataset.cmd);
    });

    // --- Contr√¥les bandeaux ---
    if (logoScaleRange) {
      const applyLogoScale = (val) => {
        const pct = `${val}%`;
        const scale = (val / 100).toFixed(2);
        root.style.setProperty('--logo-scale', scale);
        if (logoScaleValue) logoScaleValue.textContent = pct;
      };
      applyLogoScale(logoScaleRange.value);
      logoScaleRange.addEventListener('input', (event) => applyLogoScale(event.target.value));
    }

    [
      { id: 'headerWidthRange', output: 'headerWidthValue', cssVar: '--header-width', format: (v) => `${v}%` },
      { id: 'headerDepthRange', output: 'headerDepthValue', cssVar: '--header-depth', format: (v) => `${v}px` },
      { id: 'headerAngleRange', output: 'headerAngleValue', cssVar: '--header-angle', format: (v) => `${v}%` },
      { id: 'footerDepthRange', output: 'footerDepthValue', cssVar: '--footer-depth', format: (v) => `${v}px` },
      { id: 'footerAngleRange', output: 'footerAngleValue', cssVar: '--footer-notch', format: (v) => `${v}%` },
    ].forEach(({ id, output, cssVar, format }) => {
      const input = document.getElementById(id);
      if (!input) return;
      const outputEl = document.getElementById(output);
      const applyValue = (value) => {
        const formatted = format ? format(value) : value;
        root.style.setProperty(cssVar, formatted);
        if (outputEl) outputEl.textContent = formatted;
      };
      applyValue(input.value);
      input.addEventListener('input', (event) => applyValue(event.target.value));
    });
  </script>

</body>

</html>
